// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// API Key Management
model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  usage     ApiUsage[]

  @@index([key])
  @@map("api_keys")
}

// API Usage Tracking
model ApiUsage {
  id            String   @id @default(cuid())
  apiKeyId      String?
  endpoint      String
  query         String?  @db.Text
  message       String?  // Log message (e.g., "New analysis request")
  projectType   String?  // agricultural, commercial, residential, industrial
  bbox          String?  // Bounding box as JSON string
  mcpMode       String?  // 'remote' or 'local'
  toolUsed      String?
  responseTime  Int?     // milliseconds
  success       Boolean
  errorMessage  String?  @db.Text
  tokensUsed    Int?
  cost          Float?   // estimated cost in USD
  ipAddress     String?
  userAgent     String?  @db.Text
  requestId     String?  @unique
  createdAt     DateTime @default(now())
  
  // Relations
  apiKey        ApiKey?  @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  // Optimized composite indexes for common queries
  @@index([apiKeyId])
  @@index([endpoint])
  @@index([createdAt])
  @@index([success])
  @@index([endpoint, createdAt]) // Time-series queries per endpoint
  @@index([apiKeyId, createdAt]) // Per-key analytics
  @@index([success, createdAt])  // Error rate over time
  @@index([toolUsed])            // Tool popularity metrics
  @@index([projectType])         // Project type analytics
  @@map("api_usage")
}

// System Metrics (for monitoring dashboard)
model SystemMetrics {
  id                String   @id @default(cuid())
  mcpMode           String?
  mcpConnected      Boolean
  requestCount      Int
  errorCount        Int
  avgResponseTime   Float?   // milliseconds
  openRouterCost    Float?   // total cost in USD
  timestamp         DateTime @default(now())

  @@index([timestamp])
  @@map("system_metrics")
}
